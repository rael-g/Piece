@startuml
autonumber

participant "GameApp (C#)" as App
participant "InputManager (C#)" as IM
participant "Scene (C#)" as Sc
participant "Node (C#)" as Nd
participant "Component (C#)" as Comp
participant "AssetManager (C#)" as AM
participant "RenderManager (C#)" as RM
participant "AISystem (C#)" as AIS
participant "BehaviorTreeComp (C#)" as BTC

' C# Wrappers for C++ Intermediate Layer
participant "NativeCalls (C# P/Invoke)" as NC
participant "EngineCore (C++ Interm.)" as EC_Cpp
participant "ResourceManagerWrapper (C#)" as ResM_Cs
participant "RenderSystemWrapper (C#)" as RS_Cs
participant "CameraWrapper (C#)" as Cam_Cs
participant "ModelWrapper (C#)" as Mod_Cs
participant "LightWrapper (C#)" as Light_Cs
participant "MaterialWrapper (C#)" as Mat_Cs
participant "MeshWrapper (C#)" as Mesh_Cs

' C++ Intermediate Layer Components (Conceptual)
participant "ResourceManager (C++ Interm.)" as ResM_Cpp
participant "RenderSystem (C++ Interm.)" as RS_Cpp
participant "Camera (C++ Interm.)" as Cam_Cpp
participant "PhysicsSystem (C++ Interm.)" as PS_Cpp

' C++ Low-Level Implementation (Conceptual)
participant "IGraphicsDevice (C++ Low-Level Impl)" as GD_Cpp
participant "IRenderContext (C++ Low-Level Impl)" as RC_Cpp
participant "IPhysicsWorld (C++ Low-Level Impl)" as PW_Cpp


' --- Initialization Sequence ---
App -> NC: Engine_InitializeFromLibraries("gfx_opengl.dll", "physics_jolt.dll")
activate NC
NC -> EC_Cpp: Create(graphicsLibPath, physicsLibPath)
activate EC_Cpp
EC_Cpp --> NC: ec_cpp_ptr
deactivate EC_Cpp
NC --> App: engine_core_ptr
deactivate NC

App -> App: Initialize()
activate App
App -> IM: new InputManager()
App -> AIS: new AISystem()

App -> ResM_Cs: new ResourceManagerWrapper(engine_core_ptr.GetResourceManagerPtr())
App -> RS_Cs: new RenderSystemWrapper(engine_core_ptr.GetRenderSystemPtr())
App -> Cam_Cs: new CameraWrapper(engine_core_ptr.GetCameraPtr()) ' Assuming a default camera creation via EngineCore for editor/main view
App -> App: ... (Create/Load initial Scene, Nodes, Components)
deactivate App

' --- Game Loop ---
App -> App: Update(gameTime)
activate App
App -> IM: Update()
activate IM
IM --> App:
deactivate IM

App -> Sc: Update(gameTime)
activate Sc
loop each Node in Scene (hierarchical update)
  Sc -> Nd: Update(gameTime)
  activate Nd
  loop each Component in Node
    Nd -> Comp: Update(gameTime)
    activate Comp
    Comp --> Nd:
    deactivate Comp
  end
  Nd --> Sc:
  deactivate Nd
end
Sc --> App:
deactivate Sc

App -> AIS: Update(gameTime)
activate AIS
loop each BehaviorTreeComponent
  AIS -> BTC: Execute()
  activate BTC
  BTC --> AIS:
  deactivate BTC
end
AIS --> App:
deactivate AIS

' 2. Physics Update (C# triggering C++ intermediate)
App -> NC: Engine_UpdatePhysics(engine_core_ptr, gameTime.DeltaTime)
activate NC
NC -> EC_Cpp: UpdatePhysics(deltaTime)
activate EC_Cpp
EC_Cpp -> PS_Cpp: Update(deltaTime)
activate PS_Cpp
PS_Cpp -> PW_Cpp: Step(deltaTime)
activate PW_Cpp
PW_Cpp --> PS_Cpp:
deactivate PW_Cpp
PS_Cpp --> EC_Cpp:
deactivate EC_Cpp
NC --> App:
deactivate NC

' 3. Draw Phase (C# triggering C++ intermediate)
App -> App: Draw(gameTime)
activate App
RM -> Sc: GetRenderables(activeCamera) ' Collect visible nodes/components
activate Sc
Sc --> RM: collected_renderables (C# objects)
deactivate Sc

RM -> RS_Cs: RenderFrame(Cam_Cs, collected_renderables)
activate RS_Cs
RS_Cs -> NC: Engine_RenderFrame(engine_core_ptr, Cam_Cs.NativePtr, collected_renderables_native_ptrs_array, numModels)
activate NC
NC -> EC_Cpp: RenderFrame(cam_cpp_ptr, models_cpp_vector)
activate EC_Cpp
EC_Cpp -> RS_Cpp: RenderFrame(cam_cpp_ptr, models_cpp_vector)
activate RS_Cpp

RS_Cpp -> GD_Cpp: BeginFrame()
RS_Cpp -> RC_Cpp: SetViewport(...)
RS_Cpp -> RC_Cpp: Configure Camera (UBOs, View/Projection)

RS_Cpp -> RS_Cpp: Perform Culling (can use JobSystem, not shown here)
RS_Cpp -> RS_Cpp: Sort Renderables

loop for each visible Model (C++ internal)
  RS_Cpp -> Mod_Cs: GetNativePtr() ' If needed to pass C# Model around
  RS_Cpp -> ResM_Cpp: GetMesh(model_id)
  activate ResM_Cpp
  ResM_Cpp --> RS_Cpp: msh_cpp_ptr
  deactivate ResM_Cpp

  RS_Cpp -> ResM_Cpp: GetMaterial(model_id)
  activate ResM_Cpp
  ResM_Cpp --> RS_Cpp: mat_cpp_ptr
  deactivate ResM_Cpp

  RS_Cpp -> RC_Cpp: SetVertexBuffer(msh_cpp_ptr.GetVertexBuffer())
  RS_Cpp -> RC_Cpp: SetIndexBuffer(msh_cpp_ptr.GetIndexBuffer())
  RS_Cpp -> RC_Cpp: SetShaderProgram(mat_cpp_ptr.GetShaderProgram())
  RS_Cpp -> RC_Cpp: SetTexture(mat_cpp_ptr.GetTexture(...), slot)
  RS_Cpp -> RC_Cpp: SetSampler(mat_cpp_ptr.GetSampler(...), slot)
  RS_Cpp -> RC_Cpp: SetUniformBuffer(mat_cpp_ptr.GetUniformBuffer(...), bindingPoint)
  RS_Cpp -> RC_Cpp: DrawIndexed(...)
end

RS_Cpp -> EC_Cpp: PostProcessManager.ApplyEffects(RC_Cpp, ...)
RS_Cpp -> GD_Cpp: EndFrame()

RS_Cpp --> EC_Cpp:
deactivate RS_Cpp
EC_Cpp --> NC:
deactivate EC_Cpp
NC --> RS_Cs:
deactivate NC
RM --> App:
deactivate App
App --> App:
deactivate App
end
@enduml